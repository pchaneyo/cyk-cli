<?xml-model href="https://www.cyklang.net/schema/cyklang.xsd" ?>
<module>

    <db.table name="t_actor">
        <number name="actor_id" type="int" primary="" generated='by default'/>
        <string name="first_name" type="varchar(50)"/>
        <string name="last_name" type="text" />
        <datetime name="last_update" type="timestamp with time zone"/>
        <string name="cyk_remark" type="varchar(255)" />
        <boolean name="cyk_disable" type="boolean"/>
    </db.table>

    <db.table name="t_film">
        <number name="film_id" type="int" primary="" generated='by default'/>
        <string name="title" type="varchar(255)" />
        <string name="description" type="text" />
        <number name="release_year" type="int"/>
        <number name="length" type="int" />
        <number name="language_id" type="int"/>
    </db.table>

    <db.table name="t_film_actor">
        <number name="id" type="int" primary="" generated="by default"/>
        <number name="actor_id" type="int"/>
        <number name="film_id" type="int"/>
        <number name="length" type="int"/>
    </db.table>

    <query name="t_films_actors">
        <object name="params">
            <number name="length_from">0</number>
            <number name="length_to">999</number>
        </object>

        <string name="entities">"t_actor t_film"</string>
        <string name="sql" literal="">
            SELECT * FROM public.t_actor 
            join t_film_actor on t_film_actor.actor_id = t_actor.actor_id 
            join t_film on t_film_actor.film_id = t_film.film_id
            where t_film.length between {{ length_from }}  and {{ length_to }}
            -- and actor.actor_id = 2
            ORDER BY t_actor.actor_id ASC ;
        </string>
    </query>
    
    <object name="actor_maria">
        <string name="first_name">"Maria" </string>
        <string name='last_name'>'DUPONT'</string>
        <string name='cyk_remark'> 'remarque' </string>
    </object>

    <!-- <db.execute insert_into_table="actor" returning_into="actor_maria" >
        <object name="actor">actor_maria</object>
    </db.execute> -->

    <db.insert table="t_actor" returning_into="actor_maria">
        <object name="actor">actor_maria</object>
    </db.insert>

    <object name="new_film">
        <string name="title">"La mélodie du bonheur"</string>
        <string name="description">"Le film préféré de Mao"</string>
        <number name="language_id">1</number>
        <number name="release_year">2022</number>
        <number name="length">60</number>
    </object>

    <!-- <db.execute insert_into_table="film" returning_into="new_film">
        <object> new_film </object>
    </db.execute> -->

    <db.insert table="t_film" returning_into="new_film">
        <object>new_film</object>
    </db.insert>

    <print>"New film ID " + new_film.film_id </print>

    <let name="new_film.release_year"> 1965 </let>

    <!-- <db.execute update_table="film">
        <object name="film"> new_film </object>
    </db.execute> -->

    <db.update table="t_film">
        <object name="film"> new_film </object>
    </db.update>

    <!-- <db.execute insert_into_table="film_actor">
        <object>
            <number name="actor_id">actor_maria.actor_id</number>
            <number name="film_id">new_film.film_id</number>
        </object>
    </db.execute> -->

    <db.insert table="t_film_actor">
        <object>
            <number name="actor_id">actor_maria.actor_id</number>
            <number name="film_id">new_film.film_id</number>
        </object>
    </db.insert>

    <object name="films_actors" />

    <!-- <db.execute query="films_actors" result="films_actors">
        <number name="length_from">60</number>
        <number name="length_to">60</number>
    </db.execute> -->

    <runquery name="t_films_actors" result="films_actors">
        <number name="length_from">60</number>
        <number name="length_to">60</number>
    </runquery>

    <print>"films_actors.resultset.at(0).t_actor.last_name " + films_actors.resultset.at(0).t_actor.last_name</print>
    <call object="films_actors.resultset" method="foreach">
        <function>
            <object name="result" />
            <block>
                <print>"actor " + result.t_actor.actor_id + " " + result.t_actor.first_name + " " + result.t_actor.last_name 
                    + ", film " + result.t_film.film_id + " " + result.t_film.title 
                </print>
            </block>
        </function>
    </call>

    <print>"string(films_actors.resultset) : "+string(films_actors.resultset)</print>


</module>
